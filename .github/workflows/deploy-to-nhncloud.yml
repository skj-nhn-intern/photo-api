name: Deploy to NHN Cloud

on:
  pull_request:
    types:
      - closed
    branches:
      - dev
      - release

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # PR merge ì‹œì—ë§Œ ì‹¤í–‰
    if: github.event.pull_request.merged == true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # íƒœê·¸ ì •ë³´ë¥¼ ìœ„í•´ ì „ì²´ ížˆìŠ¤í† ë¦¬ í•„ìš”
          # PR mergeì˜ ê²½ìš° merge commit ì²´í¬ì•„ì›ƒ
          ref: ${{ github.event.pull_request.merge_commit_sha || github.ref }}

      - name: Determine deployment context
        id: context
        run: |
          # PR mergeì¸ ê²½ìš°ë§Œ ì²˜ë¦¬
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          
          if [[ "$BASE_BRANCH" == "release" ]]; then
            # release ë¸Œëžœì¹˜ë¡œ merge â†’ PRODUCTION
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || git log -1 --pretty=%B | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1 || echo "")
            if [ -z "$VERSION" ]; then
              echo "::error::Version not found. Ensure a version tag exists or is mentioned in commit message."
              exit 1
            fi
            BINARY_GROUP="release"
            ENVIRONMENT="PRODUCTION"
          else
            # dev ë¸Œëžœì¹˜ë¡œ merge â†’ DEV (ê¸°ë³¸ê°’)
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.1")
            BINARY_GROUP="dev"
            ENVIRONMENT="DEV"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "binary_group=$BINARY_GROUP" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Version: $VERSION"
          echo "ðŸŽ¯ Binary Group: $BINARY_GROUP"
          echo "ðŸŒ Environment: $ENVIRONMENT"

      - name: Create deployment package
        run: |
          set -e
          
          mkdir -p deploy-package
          
          # rsyncë¡œ íš¨ìœ¨ì ìœ¼ë¡œ íŒŒì¼ ë³µì‚¬ (.env ì œì™¸)
          rsync -av \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.env*' \
            --exclude='venv' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='*.pyo' \
            --exclude='*.db' \
            --exclude='*.sqlite' \
            --exclude='*.log' \
            --exclude='.DS_Store' \
            --exclude='deploy-package' \
            --exclude='*.tar.gz' \
            --exclude='*.zip' \
            --exclude='.vscode' \
            --exclude='.idea' \
            ./ deploy-package/
          
          # í™˜ê²½ë³„ .env í…œí”Œë¦¿ ìƒì„± (í…œí”Œë¦¿ íŒŒì¼ì—ì„œ ë³€ìˆ˜ ì¹˜í™˜)
          ENV_VALUE="${{ steps.context.outputs.environment }}"
          DEBUG_VALUE=$([ "$ENV_VALUE" == "PRODUCTION" ] && echo "False" || echo "True")
          
          sed -e "s/{{ENVIRONMENT}}/${ENV_VALUE}/g" -e "s/{{DEBUG}}/${DEBUG_VALUE}/g" env.template > deploy-package/.env.template
          
          # ì••ì¶• íŒŒì¼ ìƒì„±
          cd deploy-package
          tar -czf ../photo-api-${{ steps.context.outputs.version }}.tar.gz .
          cd ..
          
          # íŒŒì¼ í¬ê¸° í™•ì¸
          ls -lh photo-api-${{ steps.context.outputs.version }}.tar.gz

      - name: Upload binary to NHN Cloud Deploy
        env:
          NHN_CLOUD_APP_KEY: ${{ secrets.NHN_CLOUD_APP_KEY }}
          NHN_CLOUD_ARTIFACT_ID: ${{ secrets.NHN_CLOUD_ARTIFACT_ID }}
          NHN_CLOUD_BINARY_GROUP_ID_DEV: ${{ secrets.NHN_CLOUD_BINARY_GROUP_ID_DEV }}
          NHN_CLOUD_BINARY_GROUP_ID_RELEASE: ${{ secrets.NHN_CLOUD_BINARY_GROUP_ID_RELEASE }}
          NHN_CLOUD_AUTH_ID: ${{ secrets.NHN_CLOUD_AUTH_ID }}
          NHN_CLOUD_AUTH_SECRET: ${{ secrets.NHN_CLOUD_AUTH_SECRET }}
        run: |
          set -e
          
          # Binary Group ID ì„ íƒ
          if [[ "${{ steps.context.outputs.binary_group }}" == "release" ]]; then
            BINARY_GROUP_ID="${NHN_CLOUD_BINARY_GROUP_ID_RELEASE}"
          else
            BINARY_GROUP_ID="${NHN_CLOUD_BINARY_GROUP_ID_DEV}"
          fi
          
          if [ -z "$BINARY_GROUP_ID" ]; then
            echo "::error::Binary Group ID not found for ${{ steps.context.outputs.binary_group }}"
            exit 1
          fi
          
          PACKAGE_FILE="photo-api-${{ steps.context.outputs.version }}.tar.gz"
          
          echo "ðŸ“¤ Uploading to ${{ steps.context.outputs.binary_group }} binary group..."
          echo "ðŸ“¦ Version: ${{ steps.context.outputs.version }}"
          echo "ðŸ“ File: $PACKAGE_FILE"
          
          # NHN Cloud Deploy Binary API í˜¸ì¶œ
          RESPONSE=$(curl -sSf -X POST \
            --max-time 300 \
            "https://api-tcd.nhncloudservice.com/api/v1.0/projects/${NHN_CLOUD_APP_KEY}/artifacts/${NHN_CLOUD_ARTIFACT_ID}/binary-groups/${BINARY_GROUP_ID}/binaries" \
            -H "X-TC-AUTHENTICATION-ID: ${NHN_CLOUD_AUTH_ID}" \
            -H "X-TC-AUTHENTICATION-SECRET: ${NHN_CLOUD_AUTH_SECRET}" \
            -F "file=@${PACKAGE_FILE}" \
            -F "version=${{ steps.context.outputs.version }}" \
            -F "description=Auto-deployed from GitHub Actions (${{ steps.context.outputs.binary_group }}) on $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)")
          
          # ì‘ë‹µ í™•ì¸
          if echo "$RESPONSE" | grep -q '"isSuccess" *: *true'; then
            echo "âœ… Binary uploaded successfully"
            echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"
          else
            echo "::error::Binary upload failed"
            echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"
            exit 1
          fi

      - name: Upload artifact (for debugging)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package-${{ steps.context.outputs.binary_group }}-${{ steps.context.outputs.version }}
          path: photo-api-${{ steps.context.outputs.version }}.tar.gz
          retention-days: 7
