name: Deploy to NHN Cloud

on:
  pull_request:
    types:
      - closed
    branches:
      - dev
      - release

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # PR merge ì‹œì—ë§Œ ì‹¤í–‰
    if: github.event.pull_request.merged == true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # íƒœê·¸ ì •ë³´ë¥¼ ìœ„í•´ ì „ì²´ ížˆìŠ¤í† ë¦¬ í•„ìš”
          # PR mergeì˜ ê²½ìš° merge commit ì²´í¬ì•„ì›ƒ
          ref: ${{ github.event.pull_request.merge_commit_sha || github.ref }}

      - name: Determine deployment context
        id: context
        run: |
          # PR mergeì¸ ê²½ìš°ë§Œ ì²˜ë¦¬
          BASE_BRANCH="${{ github.event.pull_request.base.ref }}"
          
          if [[ "$BASE_BRANCH" == "release" ]]; then
            # release ë¸Œëžœì¹˜ë¡œ merge â†’ PRODUCTION
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || git log -1 --pretty=%B | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' | head -1 || echo "")
            if [ -z "$VERSION" ]; then
              echo "::error::Version not found. Ensure a version tag exists or is mentioned in commit message."
              exit 1
            fi
            BINARY_GROUP="release"
            ENVIRONMENT="PRODUCTION"
          else
            # dev ë¸Œëžœì¹˜ë¡œ merge â†’ DEV (ê¸°ë³¸ê°’)
            VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.1")
            BINARY_GROUP="dev"
            ENVIRONMENT="DEV"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "binary_group=$BINARY_GROUP" >> $GITHUB_OUTPUT
          echo "environment=$ENVIRONMENT" >> $GITHUB_OUTPUT
          
          echo "ðŸ“¦ Version: $VERSION"
          echo "ðŸŽ¯ Binary Group: $BINARY_GROUP"
          echo "ðŸŒ Environment: $ENVIRONMENT"

      - name: Create deployment package
        run: |
          set -e
          
          mkdir -p deploy-package
          
          # rsyncë¡œ íš¨ìœ¨ì ìœ¼ë¡œ íŒŒì¼ ë³µì‚¬ (.env ì œì™¸)
          rsync -av \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.env*' \
            --exclude='venv' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='*.pyo' \
            --exclude='*.db' \
            --exclude='*.sqlite' \
            --exclude='*.log' \
            --exclude='.DS_Store' \
            --exclude='deploy-package' \
            --exclude='*.tar.gz' \
            --exclude='*.zip' \
            --exclude='.vscode' \
            --exclude='.idea' \
            ./ deploy-package/
          
          # í™˜ê²½ë³„ .env í…œí”Œë¦¿ ìƒì„± (í…œí”Œë¦¿ íŒŒì¼ì—ì„œ ë³€ìˆ˜ ì¹˜í™˜)
          ENV_VALUE="${{ steps.context.outputs.environment }}"
          DEBUG_VALUE=$([ "$ENV_VALUE" == "PRODUCTION" ] && echo "False" || echo "True")
          
          sed -e "s/{{ENVIRONMENT}}/${ENV_VALUE}/g" -e "s/{{DEBUG}}/${DEBUG_VALUE}/g" env.template > deploy-package/.env.template
          
          # ì••ì¶• íŒŒì¼ ìƒì„±
          cd deploy-package
          tar -czf ../photo-api-${{ steps.context.outputs.version }}.tar.gz .
          cd ..
          
          # íŒŒì¼ í¬ê¸° í™•ì¸
          ls -lh photo-api-${{ steps.context.outputs.version }}.tar.gz

      - name: Upload binary to NHN Cloud Deploy
        env:
          NHN_CLOUD_APP_KEY: ${{ secrets.NHN_CLOUD_APP_KEY }}
          NHN_CLOUD_ARTIFACT_ID: ${{ secrets.NHN_CLOUD_ARTIFACT_ID }}
          NHN_CLOUD_BINARY_GROUP_ID_DEV: ${{ secrets.NHN_CLOUD_BINARY_GROUP_ID_DEV }}
          NHN_CLOUD_BINARY_GROUP_ID_RELEASE: ${{ secrets.NHN_CLOUD_BINARY_GROUP_ID_RELEASE }}
          NHN_CLOUD_AUTH_ID: ${{ secrets.NHN_CLOUD_AUTH_ID }}
          NHN_CLOUD_AUTH_SECRET: ${{ secrets.NHN_CLOUD_AUTH_SECRET }}
        run: |
          set -e
          
          # Binary Group ID ì„ íƒ
          if [[ "${{ steps.context.outputs.binary_group }}" == "release" ]]; then
            BINARY_GROUP_ID="${NHN_CLOUD_BINARY_GROUP_ID_RELEASE}"
          else
            BINARY_GROUP_ID="${NHN_CLOUD_BINARY_GROUP_ID_DEV}"
          fi
          
          if [ -z "$BINARY_GROUP_ID" ]; then
            echo "::error::Binary Group ID not found for ${{ steps.context.outputs.binary_group }}"
            exit 1
          fi
          
          PACKAGE_FILE="photo-api-${{ steps.context.outputs.version }}.tar.gz"
          
          # íŒŒì¼ ì¡´ìž¬ í™•ì¸
          if [ ! -f "$PACKAGE_FILE" ]; then
            echo "::error::Package file not found: $PACKAGE_FILE"
            ls -lh *.tar.gz 2>/dev/null || echo "No tar.gz files found"
            exit 1
          fi
          
          # íŒŒì¼ í¬ê¸° í™•ì¸
          FILE_SIZE=$(stat -f%z "$PACKAGE_FILE" 2>/dev/null || stat -c%s "$PACKAGE_FILE" 2>/dev/null || echo "unknown")
          echo "ðŸ“¤ Uploading to ${{ steps.context.outputs.binary_group }} binary group..."
          echo "ðŸ“¦ Version: ${{ steps.context.outputs.version }}"
          echo "ðŸ“ File: $PACKAGE_FILE (Size: $FILE_SIZE bytes)"
          echo "ðŸ”‘ App Key: ${NHN_CLOUD_APP_KEY:0:10}..." # ì²˜ìŒ 10ìžë§Œ í‘œì‹œ
          echo "ðŸ”‘ Artifact ID: ${NHN_CLOUD_ARTIFACT_ID:0:10}..." # ì²˜ìŒ 10ìžë§Œ í‘œì‹œ
          echo "ðŸ”‘ Binary Group ID: ${BINARY_GROUP_ID:0:10}..." # ì²˜ìŒ 10ìžë§Œ í‘œì‹œ
          
          # API URL êµ¬ì„±
          API_URL="https://api-tcd.nhncloudservice.com/api/v1.0/projects/${NHN_CLOUD_APP_KEY}/artifacts/${NHN_CLOUD_ARTIFACT_ID}/binary-groups/${BINARY_GROUP_ID}/binaries"
          echo "ðŸŒ API URL: ${API_URL}"
          
          # NHN Cloud Deploy Binary API í˜¸ì¶œ (ìƒì„¸ ë¡œê·¸ í¬í•¨)
          set +e  # ì—ëŸ¬ ë°œìƒí•´ë„ ê³„ì† ì§„í–‰
          RESPONSE=$(curl -v -X POST \
            --max-time 300 \
            --fail-with-body \
            --write-out "\nHTTP Status: %{http_code}\nTotal Time: %{time_total}s\n" \
            "$API_URL" \
            -H "X-TC-AUTHENTICATION-ID: ${NHN_CLOUD_AUTH_ID}" \
            -H "X-TC-AUTHENTICATION-SECRET: ${NHN_CLOUD_AUTH_SECRET}" \
            -F "file=@${PACKAGE_FILE}" \
            -F "version=${{ steps.context.outputs.version }}" \
            -F "description=Auto-deployed from GitHub Actions (${{ steps.context.outputs.binary_group }}) on $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)" \
            2>&1)
          
          CURL_EXIT_CODE=$?
          HTTP_CODE=$(echo "$RESPONSE" | grep -oP 'HTTP Status: \K\d+' || echo "unknown")
          set -e
          
          echo "--- curl Response ---"
          echo "$RESPONSE"
          echo "--- End Response ---"
          
          # HTTP ìƒíƒœ ì½”ë“œ í™•ì¸
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "201" ]; then
            echo "::error::API call failed with HTTP $HTTP_CODE"
            echo "::error::Curl exit code: $CURL_EXIT_CODE"
            echo "::error::Check API URL, authentication, and parameters"
            exit 1
          fi
          
          # ì‘ë‹µ ë³¸ë¬¸ì—ì„œ ì„±ê³µ ì—¬ë¶€ í™•ì¸
          RESPONSE_BODY=$(echo "$RESPONSE" | sed -n '/^{/,$p' | head -1)
          if echo "$RESPONSE_BODY" | grep -q '"isSuccess" *: *true'; then
            echo "âœ… Binary uploaded successfully"
            echo "$RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$RESPONSE_BODY"
          else
            echo "::error::Binary upload failed - API returned isSuccess: false"
            echo "Response body:"
            echo "$RESPONSE_BODY" | jq '.' 2>/dev/null || echo "$RESPONSE_BODY"
            exit 1
          fi

      - name: Upload artifact (for debugging)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package-${{ steps.context.outputs.binary_group }}-${{ steps.context.outputs.version }}
          path: photo-api-${{ steps.context.outputs.version }}.tar.gz
          retention-days: 7
