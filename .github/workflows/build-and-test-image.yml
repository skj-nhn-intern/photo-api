name: Build and Test NHN Cloud Instance Image

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      skip_cleanup:
        description: 'Skip resource cleanup (for debugging)'
        required: false
        default: 'false'

env:
  PYTHON_VERSION: '3.11'
  PROMTAIL_VERSION: '3.6.4'
  NODE_EXPORTER_VERSION: '1.10.0'

jobs:
  build-and-create-image:
    name: Build and create image (KR1, KR2)
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    outputs:
      build_instance_id: ${{ steps.create_instance.outputs.instance_id }}
      test_instance_id: ${{ steps.test_instance.outputs.test_instance_id }}
      compute_url: ${{ steps.create_instance.outputs.compute_url }}
      keypair_name: ${{ steps.create_instance.outputs.keypair_name }}
      build_floating_ip_id: ${{ steps.create_instance.outputs.floating_ip_id }}
      test_floating_ip_id: ${{ steps.test_instance.outputs.test_floating_ip_id }}
    steps:
      - name: Set KR1 for build and test
        run: |
          echo "NHN_REGION=KR1" >> $GITHUB_ENV
          if [ -n "${{ secrets.NHN_NETWORK_ID_KR1 }}" ]; then
            echo "NHN_NETWORK_ID=${{ secrets.NHN_NETWORK_ID_KR1 }}" >> $GITHUB_ENV
          else
            echo "NHN_NETWORK_ID=${{ secrets.NHN_NETWORK_ID }}" >> $GITHUB_ENV
          fi
          echo "ì´ë¯¸ì§€ ì—…ë¡œë“œ(create image): KR1, KR2 ë™ì¼í•˜ê²Œ. ì‹¤ì œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸: KR1ë§Œ."

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install NHN Cloud CLI dependencies
        run: |
          pip install --upgrade pip
          pip install requests python-dotenv

      - name: Create temporary SSH key
        id: ssh_key
        run: |
          ssh-keygen -t rsa -b 4096 -f ~/.ssh/nhn_temp_key -N "" -C "github-actions-temp"
          echo "private_key_path=$HOME/.ssh/nhn_temp_key" >> $GITHUB_OUTPUT
          echo "public_key_path=$HOME/.ssh/nhn_temp_key.pub" >> $GITHUB_OUTPUT
          chmod 600 ~/.ssh/nhn_temp_key

      - name: Create build instance on NHN Cloud
        id: create_instance
        env:
          NHN_AUTH_URL: ${{ secrets.NHN_AUTH_URL }}
          NHN_TENANT_ID: ${{ secrets.NHN_TENANT_ID }}
          NHN_USERNAME: ${{ secrets.NHN_USERNAME }}
          NHN_PASSWORD: ${{ secrets.NHN_PASSWORD }}
          NHN_FLAVOR_NAME: ${{ secrets.NHN_FLAVOR_NAME }}
          NHN_IMAGE_NAME: ${{ secrets.NHN_IMAGE_NAME }}
          NHN_SECURITY_GROUP_ID: ${{ secrets.NHN_SECURITY_GROUP_ID }}
          NHN_FLOATING_IP_POOL: ${{ secrets.NHN_FLOATING_IP_POOL }}
          SSH_PUBLIC_KEY: ${{ steps.ssh_key.outputs.public_key_path }}
        run: python3 scripts/ci/create_build_instance.py

      - name: Wait for SSH to be ready
        run: |
          echo "â³ SSH ì„œë¹„ìŠ¤ ì¤€ë¹„ ëŒ€ê¸° ì¤‘..."
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 \
                -i ${{ steps.ssh_key.outputs.private_key_path }} \
                ubuntu@${{ steps.create_instance.outputs.instance_ip }} \
                "echo 'SSH ì—°ê²° ì„±ê³µ'" 2>/dev/null; then
              echo "âœ… SSH ì—°ê²° ê°€ëŠ¥"
              break
            fi
            
            attempt=$((attempt + 1))
            echo "  ì‹œë„ $attempt/$max_attempts..."
            sleep 10
          done
          
          if [ $attempt -eq $max_attempts ]; then
            echo "âŒ SSH ì—°ê²° ì‹¤íŒ¨"
            exit 1
          fi

      - name: Prepare build environment
        run: |
          echo "ğŸ“¦ ë¹Œë“œ í™˜ê²½ ì„¤ì • ì¤‘..."
          
          # LOKI_URL: Secret ê°’ ì•ë’¤ ê³µë°±/ì¤„ë°”ê¿ˆ ì œê±° í›„ ì‚¬ìš© (GitHub UI ë¶™ì—¬ë„£ê¸° ì‹œ í¬í•¨ë  ìˆ˜ ìˆìŒ)
          LOKI_URL_TRIM="${{ secrets.LOKI_URL }}"
          LOKI_URL_TRIM=$(echo "$LOKI_URL_TRIM" | tr -d '\n\r' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± (ë©”íŠ¸ë¦­: /metrics ìŠ¤í¬ë˜í•‘, Pushgateway ì„ íƒ)
          cat > .env.build << ENVEOF
          LOKI_URL=${LOKI_URL_TRIM}
          INSTANCE_IP=${{ steps.create_instance.outputs.instance_ip }}
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          PROMETHEUS_PUSHGATEWAY_URL=${{ secrets.PROMETHEUS_PUSHGATEWAY_URL }}
          PROMETHEUS_PUSH_INTERVAL_SECONDS=${{ secrets.PROMETHEUS_PUSH_INTERVAL_SECONDS }}
          NHN_OBJECT_STORAGE_ENDPOINT=${{ secrets.NHN_OBJECT_STORAGE_ENDPOINT }}
          NHN_OBJECT_STORAGE_ACCESS_KEY=${{ secrets.NHN_OBJECT_STORAGE_ACCESS_KEY }}
          NHN_OBJECT_STORAGE_SECRET_KEY=${{ secrets.NHN_OBJECT_STORAGE_SECRET_KEY }}
          NHN_CDN_DOMAIN=${{ secrets.NHN_CDN_DOMAIN }}
          NHN_CDN_AUTH_KEY=${{ secrets.NHN_CDN_AUTH_KEY }}
          ENVEOF
          
          # LOKI_URL ë¯¸ì„¤ì • ì‹œ ì´ë¯¸ì§€ì— ë¹ˆ ê°’ì´ ë“¤ì–´ê°€ Promtailì´ ê¸°ë™í•˜ì§€ ì•ŠìŒ â†’ ë¹Œë“œ ì‹¤íŒ¨ë¡œ ì¡°ê¸° ë°œê²¬
          LOKI_VAL=$(grep '^LOKI_URL=' .env.build 2>/dev/null | cut -d= -f2-)
          if [ -z "$LOKI_VAL" ]; then
            echo "::error::LOKI_URL is not set. Add LOKI_URL to Repository Secrets (Settings > Secrets and variables > Actions) and re-run. Name must be exactly: LOKI_URL"
            exit 1
          fi
          echo "âœ… LOKI_URL ì„¤ì •ë¨ (ê°’ ê¸¸ì´: ${#LOKI_VAL}ì, ì´ë¯¸ì§€ ë¹Œë“œì— ë°˜ì˜ë©ë‹ˆë‹¤)"

      - name: Upload source code to build instance
        run: |
          echo "ğŸ“¤ ì†ŒìŠ¤ ì½”ë“œ ì—…ë¡œë“œ ì¤‘..."
          
          # rsyncë¡œ ì†ŒìŠ¤ ì½”ë“œ ì „ì†¡
          rsync -avz --exclude='.git' --exclude='__pycache__' --exclude='*.pyc' \
            --exclude='venv' --exclude='.env' --exclude='*.log' \
            -e "ssh -o StrictHostKeyChecking=no -i ${{ steps.ssh_key.outputs.private_key_path }}" \
            ./ ubuntu@${{ steps.create_instance.outputs.instance_ip }}:/tmp/photo-api/
          
          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ì „ì†¡
          scp -o StrictHostKeyChecking=no \
            -i ${{ steps.ssh_key.outputs.private_key_path }} \
            .env.build ubuntu@${{ steps.create_instance.outputs.instance_ip }}:/tmp/photo-api/.env
          
          echo "âœ… ì†ŒìŠ¤ ì½”ë“œ ì—…ë¡œë“œ ì™„ë£Œ"

      - name: Download dependencies offline
        run: |
          echo "ğŸ“¥ ì˜¤í”„ë¼ì¸ ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          
          # Python íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ
          mkdir -p offline-packages
          pip download -r requirements.txt -d offline-packages/
          
          # Promtail ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ
          echo "ğŸ“¥ Promtail ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ ì¤‘..."
          curl -sSL -o offline-packages/promtail.zip \
            "https://github.com/grafana/loki/releases/download/v${PROMTAIL_VERSION}/promtail-linux-amd64.zip"
          # node_exporter (ì¸ìŠ¤í„´ìŠ¤ ë¦¬ì†ŒìŠ¤ ë©”íŠ¸ë¦­)
          echo "ğŸ“¥ node_exporter ë‹¤ìš´ë¡œë“œ ì¤‘..."
          curl -sSL -o offline-packages/node_exporter.tar.gz \
            "https://github.com/prometheus/node_exporter/releases/download/v${NODE_EXPORTER_VERSION}/node_exporter-${NODE_EXPORTER_VERSION}.linux-amd64.tar.gz"
          
          echo "âœ… ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"

      - name: Upload offline packages to build instance
        run: |
          echo "ğŸ“¤ ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ ì¤‘..."
          
          rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no -i ${{ steps.ssh_key.outputs.private_key_path }}" \
            offline-packages/ ubuntu@${{ steps.create_instance.outputs.instance_ip }}:/tmp/offline-packages/
          
          echo "âœ… ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ ì—…ë¡œë“œ ì™„ë£Œ"

      - name: Build image on instance
        run: |
          echo "ğŸ”¨ ì¸ìŠ¤í„´ìŠ¤ ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
          
          ssh -o StrictHostKeyChecking=no \
            -i ${{ steps.ssh_key.outputs.private_key_path }} \
            ubuntu@${{ steps.create_instance.outputs.instance_ip }} << 'REMOTE_SCRIPT'
          set -euo pipefail
          
          echo "=== 1ë‹¨ê³„: Python ì„¤ì¹˜ ==="
          sudo DEBIAN_FRONTEND=noninteractive apt-get update -qq
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -qq \
            curl ca-certificates build-essential libffi-dev libssl-dev \
            software-properties-common unzip
          
          sudo add-apt-repository -y ppa:deadsnakes/ppa
          sudo apt-get update -qq
          sudo apt-get install -y -qq python3.11 python3.11-venv python3.11-dev
          
          echo "=== 2ë‹¨ê³„: Photo API ì„¤ì • ==="
          sudo mkdir -p /opt/photo-api /var/log/photo-api
          sudo rsync -a /tmp/photo-api/ /opt/photo-api/
          sudo chmod 755 /var/log/photo-api
          
          # ì „ìš© ì‚¬ìš©ì ìƒì„±
          sudo useradd -r -s /usr/sbin/nologin -d /opt/photo-api photo-api 2>/dev/null || true
          
          # Python ê°€ìƒí™˜ê²½ ë° ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜
          python3.11 -m venv /opt/photo-api/venv
          /opt/photo-api/venv/bin/pip install --upgrade pip --no-index --find-links=/tmp/offline-packages
          /opt/photo-api/venv/bin/pip install --no-index --find-links=/tmp/offline-packages -r /opt/photo-api/requirements.txt
          
          # systemd ì„œë¹„ìŠ¤ ìƒì„±
          sudo tee /etc/systemd/system/photo-api.service > /dev/null << 'SVC'
          [Unit]
          Description=Photo API
          After=network.target

          [Service]
          Type=simple
          User=photo-api
          Group=photo-api
          WorkingDirectory=/opt/photo-api
          Environment="PATH=/opt/photo-api/venv/bin:/usr/local/bin:/usr/bin:/bin"
          EnvironmentFile=/opt/photo-api/.env
          ExecStart=/opt/photo-api/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000
          Restart=on-failure
          RestartSec=5
          StandardOutput=journal
          StandardError=journal
          SyslogIdentifier=photo-api
          ReadWritePaths=/var/log/photo-api

          [Install]
          WantedBy=multi-user.target
          SVC
          
          sudo chown -R photo-api:photo-api /opt/photo-api /var/log/photo-api
          
          echo "=== 3ë‹¨ê³„: Promtail ì„¤ì • ==="
          sudo mkdir -p /opt/promtail /var/lib/promtail
          
          # ì˜¤í”„ë¼ì¸ íŒ¨í‚¤ì§€ì—ì„œ ì„¤ì¹˜
          unzip -q /tmp/offline-packages/promtail.zip -d /tmp/
          sudo mv /tmp/promtail-linux-amd64 /opt/promtail/promtail 2>/dev/null || \
            sudo mv /tmp/promtail /opt/promtail/promtail
          sudo chmod +x /opt/promtail/promtail
          
          sudo cp /opt/photo-api/conf/promtail-config.yaml /opt/promtail/promtail-config.yaml
          sudo cp /opt/photo-api/conf/promtail.service /etc/systemd/system/promtail.service
          
          echo "=== 4ë‹¨ê³„: node_exporter ì„¤ì • (ì¸ìŠ¤í„´ìŠ¤ ë¦¬ì†ŒìŠ¤ ë©”íŠ¸ë¦­) ==="
          sudo useradd -r -s /usr/sbin/nologin -d /opt/node_exporter node-exporter 2>/dev/null || true
          sudo mkdir -p /opt/node_exporter
          sudo tar -xzf /tmp/offline-packages/node_exporter.tar.gz -C /tmp/
          sudo mv /tmp/node_exporter-*.linux-amd64/node_exporter /opt/node_exporter/
          sudo rm -rf /tmp/node_exporter-*.linux-amd64
          sudo chown -R node-exporter:node-exporter /opt/node_exporter
          sudo cp /opt/photo-api/conf/node_exporter.service /etc/systemd/system/node_exporter.service
          
          echo "=== systemd ì„œë¹„ìŠ¤ í™œì„±í™” ==="
          sudo systemctl daemon-reload
          sudo systemctl enable photo-api.service
          sudo systemctl enable promtail.service
          sudo systemctl enable node_exporter.service
          
          echo "=== ì •ë¦¬ ==="
          sudo rm -rf /tmp/photo-api /tmp/offline-packages
          
          echo "âœ… ì´ë¯¸ì§€ ë¹Œë“œ ì™„ë£Œ"
          REMOTE_SCRIPT
          
          echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ë¹Œë“œ ì™„ë£Œ"

      - name: Start services and verify API before image creation
        run: |
          INSTANCE_IP="${{ steps.create_instance.outputs.instance_ip }}"
          SSH_OPTS="-o StrictHostKeyChecking=no -i ${{ steps.ssh_key.outputs.private_key_path }}"
          
          echo "ğŸ”„ ì„œë¹„ìŠ¤ ì‹œì‘ ì¤‘..."
          ssh $SSH_OPTS ubuntu@${INSTANCE_IP} "sudo systemctl start photo-api.service && sleep 8"
          
          echo "ğŸ“‹ ì„œë¹„ìŠ¤ ìƒíƒœ ë° ë¡œê·¸ (ì›ì¸ íŒŒì•…ìš©)"
          ssh $SSH_OPTS ubuntu@${INSTANCE_IP} << 'DIAG'
            echo "=== photo-api.service status ==="
            sudo systemctl status photo-api.service --no-pager || true
            echo "=== journalctl -u photo-api -n 60 ==="
            sudo journalctl -u photo-api -n 60 --no-pager || true
            echo "=== ë¡œì»¬ì—ì„œ 8000 í¬íŠ¸ í™•ì¸ ==="
            curl -s -o /dev/null -w "localhost:8000/health â†’ HTTP %{http_code}\n" http://127.0.0.1:8000/health || echo "localhost ì—°ê²° ì‹¤íŒ¨"
          DIAG
          
          echo "ğŸ” ë¹Œë“œ ì¸ìŠ¤í„´ìŠ¤ API í—¬ìŠ¤ì²´í¬ (Floating IP:8000)..."
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            code=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 "http://${INSTANCE_IP}:8000/health" || echo "000")
            if [ "$code" = "200" ]; then
              echo "âœ… API ì •ìƒ ì‘ë‹µ (HTTP $code) â€” ì´ë¯¸ì§€ ìƒì„± ì§„í–‰"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "  ì‹œë„ $attempt/$max_attempts: HTTP $code, ëŒ€ê¸° ì¤‘..."
            sleep 10
          done
          
          echo "âŒ ì´ë¯¸ì§€ ìƒì„± ì¤‘ë‹¨: http://${INSTANCE_IP}:8000/health ê°€ ì •ìƒ(200)ì´ ì•„ë‹™ë‹ˆë‹¤."
          echo "ğŸ“‹ ì‹¤íŒ¨ ì‹œì  ì„œë¹„ìŠ¤ ë¡œê·¸:"
          ssh $SSH_OPTS ubuntu@${INSTANCE_IP} "sudo systemctl status photo-api.service --no-pager || true; sudo journalctl -u photo-api -n 80 --no-pager || true"
          exit 1

      - name: Prepare image for first-boot SSH (cloud-init clean)
        run: |
          ssh -o StrictHostKeyChecking=no -i ${{ steps.ssh_key.outputs.private_key_path }} \
            ubuntu@${{ steps.create_instance.outputs.instance_ip }} \
            "sudo cloud-init clean && sudo sync"
          echo "âœ… cloud-init ìƒíƒœ ì´ˆê¸°í™” ì™„ë£Œ â†’ ì´ ì´ë¯¸ì§€ë¡œ ë„ìš´ ì¸ìŠ¤í„´ìŠ¤ëŠ” ì²« ë¶€íŒ… ì‹œ cloud-initì´ ì‹¤í–‰ë˜ì–´ SSH í‚¤ê°€ ì£¼ì…ë©ë‹ˆë‹¤."

      - name: Stop instance before creating image
        env:
          TOKEN: ${{ steps.create_instance.outputs.token }}
          COMPUTE_URL: ${{ steps.create_instance.outputs.compute_url }}
          INSTANCE_ID: ${{ steps.create_instance.outputs.instance_id }}
        run: python3 scripts/ci/stop_instance.py

      - name: Create instance image
        id: create_image
        env:
          TOKEN: ${{ steps.create_instance.outputs.token }}
          COMPUTE_URL: ${{ steps.create_instance.outputs.compute_url }}
          VOLUME_URL: ${{ steps.create_instance.outputs.volume_url }}
          INSTANCE_ID: ${{ steps.create_instance.outputs.instance_id }}
          GIT_SHA: ${{ github.sha }}
        run: python3 scripts/ci/create_image.py

      - name: Create test instance from image (KR1ë§Œ, ì‹¤ì œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸)
        id: test_instance
        env:
          TOKEN: ${{ steps.create_instance.outputs.token }}
          COMPUTE_URL: ${{ steps.create_instance.outputs.compute_url }}
          IMAGE_ID: ${{ steps.create_image.outputs.image_id }}
          NHN_FLAVOR_NAME: ${{ secrets.NHN_FLAVOR_NAME }}
          NHN_SECURITY_GROUP_ID: ${{ secrets.NHN_SECURITY_GROUP_ID }}
          NHN_FLOATING_IP_POOL: ${{ secrets.NHN_FLOATING_IP_POOL }}
          KEYPAIR_NAME: ${{ steps.create_instance.outputs.keypair_name }}
        run: python3 scripts/ci/create_test_instance.py

      - name: Wait for test instance services
        run: |
          echo "â³ ì„œë¹„ìŠ¤ ì‹œì‘ ëŒ€ê¸° ì¤‘..."
          sleep 60  # systemd ì„œë¹„ìŠ¤ê°€ ë¶€íŒ… ì‹œ ìë™ ì‹œì‘ë˜ë„ë¡ ëŒ€ê¸°

      - name: Test image with curl (KR1ë§Œ)
        run: |
          echo "ğŸ§ª ì´ë¯¸ì§€ í…ŒìŠ¤íŠ¸ ì¤‘ (KR1, ì‹¤ì œ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ë§Œ)..."
          
          max_attempts=30
          attempt=0
          
          while [ $attempt -lt $max_attempts ]; do
            echo "  ì‹œë„ $((attempt + 1))/$max_attempts: Health check..."
            
            if curl -f -s -o /dev/null -w "%{http_code}" \
                http://${{ steps.test_instance.outputs.test_instance_ip }}:8000/health | grep -q 200; then
              echo "âœ… Health check ì„±ê³µ"
              
              # API ì •ë³´ í™•ì¸
              echo "ğŸ“Š API ì •ë³´:"
              curl -s http://${{ steps.test_instance.outputs.test_instance_ip }}:8000/ | jq .
              
              # Metrics í™•ì¸ (ì•± /metrics, node_exporter ì¸ìŠ¤í„´ìŠ¤ ë¦¬ì†ŒìŠ¤)
              echo "ğŸ“ˆ ì•± ë©”íŠ¸ë¦­ (8000):"
              curl -s http://${{ steps.test_instance.outputs.test_instance_ip }}:8000/metrics | head -15
              echo "ğŸ“ˆ node_exporter ë©”íŠ¸ë¦­ (9100):"
              curl -s http://${{ steps.test_instance.outputs.test_instance_ip }}:9100/metrics | head -10
              
              echo "âœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼"
              exit 0
            fi
            
            attempt=$((attempt + 1))
            sleep 10
          done
          
          echo "âŒ Health check ì‹¤íŒ¨"
          
          # ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘
          echo "ğŸ” ë””ë²„ê¹… ì •ë³´ ìˆ˜ì§‘ ì¤‘..."
          ssh -o StrictHostKeyChecking=no \
            -i ${{ steps.ssh_key.outputs.private_key_path }} \
            ubuntu@${{ steps.test_instance.outputs.test_instance_ip }} << 'DEBUG'
          echo "=== systemd ì„œë¹„ìŠ¤ ìƒíƒœ ==="
          sudo systemctl status photo-api.service --no-pager || true
          echo "=== photo-api ë¡œê·¸ ==="
          sudo journalctl -u photo-api.service -n 50 --no-pager || true
          echo "=== í”„ë¡œì„¸ìŠ¤ í™•ì¸ ==="
          ps aux | grep -E 'uvicorn|python' || true
          echo "=== í¬íŠ¸ í™•ì¸ ==="
          sudo netstat -tlnp | grep 8000 || true
          DEBUG
          
          exit 1

      # KR2 ì´ë¯¸ì§€ ì—…ë¡œë“œ ë¹„í™œì„±í™” (í•„ìš”ì‹œ í™œì„±í™”)
      # - name: Upload image to KR2 (ì´ë¯¸ì§€ ì—…ë¡œë“œë§Œ, ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì—†ìŒ)
      #   id: upload_image_kr2
      #   continue-on-error: true
      #   env:
      #     TOKEN: ${{ steps.create_instance.outputs.token }}
      #     COMPUTE_URL: ${{ steps.create_instance.outputs.compute_url }}
      #     SOURCE_IMAGE_BASE_URL: ${{ secrets.NHN_IMAGE_BASE_URL_KR1 }}
      #     SOURCE_IMAGE_ID: ${{ steps.create_image.outputs.image_id }}
      #     SOURCE_IMAGE_NAME: ${{ steps.create_image.outputs.image_name }}
      #     TARGET_REGION: KR2
      #     TARGET_IMAGE_BASE_URL: ${{ secrets.NHN_IMAGE_BASE_URL_KR2 }}
      #   run: python3 scripts/ci/copy_image_to_region.py

      - name: Summary
        if: always()
        run: |
          echo "## ğŸ‰ Build and create image (KR1, KR2) ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| í•­ëª© | ê°’ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ë¹Œë“œÂ·í…ŒìŠ¤íŠ¸ ë¦¬ì „ | KR1 |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¹Œë“œ ì¸ìŠ¤í„´ìŠ¤ ID | ${{ steps.create_instance.outputs.instance_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ë¹Œë“œ ì¸ìŠ¤í„´ìŠ¤ IP | ${{ steps.create_instance.outputs.instance_ip }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì´ë¯¸ì§€ ì´ë¦„ | ${{ steps.create_image.outputs.image_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| KR1 ì´ë¯¸ì§€ ID | ${{ steps.create_image.outputs.image_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| KR2 ì´ë¯¸ì§€ ID | - (ë¹„í™œì„±í™”ë¨) |" >> $GITHUB_STEP_SUMMARY
          echo "| í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ID | ${{ steps.test_instance.outputs.test_instance_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| í…ŒìŠ¤íŠ¸ ì¸ìŠ¤í„´ìŠ¤ IP | ${{ steps.test_instance.outputs.test_instance_ip }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ì´ë¯¸ì§€ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **ì´ë¯¸ì§€ ì´ë¦„**: ${{ steps.create_image.outputs.image_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **KR1 ì´ë¯¸ì§€ ID**: ${{ steps.create_image.outputs.image_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **KR2 ì´ë¯¸ì§€ ID**: - (ë¹„í™œì„±í™”ë¨)" >> $GITHUB_STEP_SUMMARY
          echo "- **Git Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¹Œë“œ ì‹œê°„**: $(date -u)" >> $GITHUB_STEP_SUMMARY

  # ì‹¤íŒ¨/ì·¨ì†Œ/íƒ€ì„ì•„ì›ƒ ì‹œì—ë„ ë¹Œë“œ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜ë“œì‹œ ì‚­ì œ (ê°™ì€ job ë‚´ Cleanupì´ ì·¨ì†Œ ì‹œ ìŠ¤í‚µë  ìˆ˜ ìˆìŒ)
  cleanup-resources:
    name: Cleanup resources (always)
    runs-on: ubuntu-22.04
    needs: build-and-create-image
    if: always() && github.event.inputs.skip_cleanup != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: pip install --upgrade pip && pip install requests

      - name: Get NHN token
        id: get_token
        env:
          NHN_AUTH_URL: ${{ secrets.NHN_AUTH_URL }}
          NHN_TENANT_ID: ${{ secrets.NHN_TENANT_ID }}
          NHN_USERNAME: ${{ secrets.NHN_USERNAME }}
          NHN_PASSWORD: ${{ secrets.NHN_PASSWORD }}
          NHN_REGION: KR1
        run: cd scripts/ci && python3 get_token.py

      - name: Cleanup KR1 resources
        env:
          TOKEN: ${{ steps.get_token.outputs.token }}
          COMPUTE_URL: ${{ steps.get_token.outputs.compute_url }}
          BUILD_INSTANCE_ID: ${{ needs.build-and-create-image.outputs.build_instance_id }}
          TEST_INSTANCE_ID: ${{ needs.build-and-create-image.outputs.test_instance_id }}
          BUILD_FLOATING_IP_ID: ${{ needs.build-and-create-image.outputs.build_floating_ip_id }}
          TEST_FLOATING_IP_ID: ${{ needs.build-and-create-image.outputs.test_floating_ip_id }}
          KEYPAIR_NAME: ${{ needs.build-and-create-image.outputs.keypair_name }}
        run: cd scripts/ci && python3 cleanup.py
