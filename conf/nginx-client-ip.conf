# Nginx 프록시 설정 - 클라이언트 IP 전달 설정
#
# 이 설정은 Nginx를 리버스 프록시로 사용할 때 실제 클라이언트 IP를
# 백엔드 애플리케이션에 전달하기 위한 설정입니다.
#
# 사용법:
# 1. /etc/nginx/conf.d/ 또는 /etc/nginx/sites-available/에 이 파일을 복사
# 2. server_name과 backend 주소를 환경에 맞게 수정
# 3. nginx -t 로 설정 검증
# 4. systemctl reload nginx 로 적용

# 업스트림 백엔드 서버 정의
upstream photo_api_backend {
    # 백엔드 애플리케이션 서버 주소
    server 127.0.0.1:8000;
    
    # 로드밸런싱이 필요한 경우 서버 추가
    # server 127.0.0.1:8001;
    # server 127.0.0.1:8002;
    
    # Keep-alive 설정으로 성능 향상
    keepalive 32;
}

server {
    listen 80;
    server_name your-domain.com;
    
    # 클라이언트 요청 바디 최대 크기 (사진 업로드 고려)
    client_max_body_size 100M;
    
    # 타임아웃 설정
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    
    # 로그 설정
    access_log /var/log/nginx/photo-api-access.log;
    error_log /var/log/nginx/photo-api-error.log;
    
    # API 엔드포인트
    location /api/ {
        # 백엔드 URL 재작성 (/api/auth/login -> /auth/login)
        rewrite ^/api/(.*) /$1 break;
        
        # 백엔드로 프록시
        proxy_pass http://photo_api_backend;
        
        # ========================================
        # 클라이언트 IP 전달 설정 (중요!)
        # ========================================
        
        # 실제 클라이언트 IP를 X-Forwarded-For 헤더로 전달
        # $proxy_add_x_forwarded_for는 기존 X-Forwarded-For에 $remote_addr를 추가
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        # 실제 클라이언트 IP를 X-Real-IP 헤더로 전달
        proxy_set_header X-Real-IP $remote_addr;
        
        # 원본 프로토콜 전달 (http 또는 https)
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 원본 호스트 전달
        proxy_set_header X-Forwarded-Host $host;
        
        # Host 헤더 전달
        proxy_set_header Host $host;
        
        # ========================================
        # 보안 설정
        # ========================================
        
        # 외부에서 들어온 X-Forwarded-* 헤더 제거 (스푸핑 방지)
        # 이 설정은 location 블록 시작 부분에 있어야 함
        # 주의: proxy_set_header보다 먼저 실행되지 않으므로,
        # 대신 프록시 레벨에서 처리하거나 백엔드에서 검증 필요
        
        # ========================================
        # 기타 프록시 헤더
        # ========================================
        
        # 연결 업그레이드 지원 (WebSocket 등)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 타임아웃 설정
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 프론트엔드 정적 파일 (선택사항)
    location / {
        root /var/www/photo-app/dist;
        try_files $uri $uri/ /index.html;
    }
    
    # Health check 엔드포인트
    location /health {
        proxy_pass http://photo_api_backend/health;
        access_log off;  # 헬스체크는 로그에 남기지 않음
    }
}

# HTTPS 설정 (프로덕션 환경 권장)
server {
    listen 443 ssl http2;
    server_name your-domain.com;
    
    # SSL 인증서 설정
    ssl_certificate /etc/nginx/ssl/certificate.crt;
    ssl_certificate_key /etc/nginx/ssl/private.key;
    
    # SSL 보안 설정
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    
    # 클라이언트 요청 바디 최대 크기
    client_max_body_size 100M;
    
    # 로그 설정
    access_log /var/log/nginx/photo-api-access-ssl.log;
    error_log /var/log/nginx/photo-api-error-ssl.log;
    
    # API 엔드포인트
    location /api/ {
        rewrite ^/api/(.*) /$1 break;
        proxy_pass http://photo_api_backend;
        
        # 클라이언트 IP 전달
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-Proto $scheme;  # https로 전달됨
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header Host $host;
        
        # 기타 프록시 설정
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 타임아웃 설정
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # 프론트엔드 정적 파일
    location / {
        root /var/www/photo-app/dist;
        try_files $uri $uri/ /index.html;
    }
    
    # Health check
    location /health {
        proxy_pass http://photo_api_backend/health;
        access_log off;
    }
}

# HTTP to HTTPS 리다이렉트 (프로덕션 환경 권장)
# server {
#     listen 80;
#     server_name your-domain.com;
#     return 301 https://$server_name$request_uri;
# }

# ========================================
# 보안 강화 설정 (선택사항)
# ========================================

# 신뢰할 수 있는 프록시 IP 설정
# 이 설정은 nginx.conf의 http 블록에 추가
# set_real_ip_from 10.0.0.0/8;      # 내부 네트워크
# set_real_ip_from 172.16.0.0/12;   # 내부 네트워크
# set_real_ip_from 192.168.0.0/16;  # 내부 네트워크
# real_ip_header X-Forwarded-For;
# real_ip_recursive on;

# Cloudflare를 사용하는 경우 (cloudflare IP 범위 추가)
# https://www.cloudflare.com/ips/
# set_real_ip_from 103.21.244.0/22;
# set_real_ip_from 103.22.200.0/22;
# ... (모든 Cloudflare IP 범위 추가)
# real_ip_header CF-Connecting-IP;
