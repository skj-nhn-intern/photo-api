sequenceDiagram
    participant Client as 클라이언트 (브라우저)
    participant API as Photo API (FastAPI)
    participant DB as DB
    participant Storage as NHN Object Storage (Swift API)

    Note over Client,Storage: 1. 업로드 URL 발급
    Client->>+API: POST /photos/presigned-url<br/>{ album_id, filename, content_type, file_size }<br/>Header: Authorization: Bearer {JWT}
    API->>API: JWT 검증, 파일 크기/타입 검증
    API->>DB: 앨범 존재 및 권한 확인
    API->>DB: Photo 레코드 생성 (pending)<br/>storage_path = photo/photo/image/{album_id}/{uuid}.{ext}
    API->>API: generate_temp_upload_url(storage_path, content_type)<br/>path = /v1/AUTH_{tenant}/{container}/{object_name}<br/>hmac_body = "PUT\n{expires}\n{path}"<br/>sig = HMAC-SHA256(temp_url_key, hmac_body)<br/>url = endpoint + path + ?temp_url_sig=&temp_url_expires=
    API->>DB: 앨범에 photo 추가, commit
    API-->>-Client: 200 { photo_id, upload_url, upload_method: "PUT", upload_headers: { "Content-Type": "..." }, expires_in }

    Note over Client,Storage: 2. 브라우저 → Object Storage 직접 업로드 (CORS preflight)
    Client->>Storage: OPTIONS upload_url<br/>(CORS preflight — PUT + Content-Type)
    Storage-->>Client: 200 + CORS 헤더
    Client->>Storage: PUT upload_url<br/>Header: Content-Type (upload_headers)<br/>Body: file binary
    Storage-->>Client: 201 Created (temp_url_sig·temp_url_expires 검증 후 저장)

    Note over Client,API: 3. 업로드 완료 확인
    Client->>+API: POST /photos/confirm<br/>{ photo_id }<br/>Header: Authorization: Bearer {JWT}
    API->>DB: photo 조회, 소유권 확인
    API->>Storage: HEAD {container}/{object_name}<br/>X-Auth-Token (IAM) — file_exists()
    Storage-->>API: 200 OK (파일 존재)
    API->>DB: photo 유지 (이미 생성됨)
    API-->>-Client: 200 { photo_id, filename, url, message }
